{% extends "base.html" %}

{% block page_title %}Export Center - InterviewOS{% endblock %}
{% block title %}Export Center{% endblock %}

{% block content %}
<div class="export-layout">
    <div class="export-intro card">
        <div class="intro-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        </div>
        <div class="intro-content">
            <h2>Export Candidate Data</h2>
            <p>Download candidate information based on your filter criteria. Select the filters below and export the data in JSON format.</p>
        </div>
    </div>

    <form action="{{ url_for('analytics.export_download') }}" method="POST" class="export-form card" id="exportForm">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/>
                </svg>
                Export Filters
            </h3>
        </div>

        <div class="export-filters">
            <div class="filter-row">
                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Date Range
                    </label>
                    <div class="date-range">
                        <input type="date" name="start_date" value="{{ start_date }}" placeholder="Start date">
                        <span class="date-separator">to</span>
                        <input type="date" name="end_date" value="{{ end_date }}" placeholder="End date">
                    </div>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M8 12l2 2 4-4"/>
                        </svg>
                        Workflow Status
                    </label>
                    <select name="status" multiple class="select-multi">
                        {% for s in workflow_statuses %}
                        <option value="{{ s }}">{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                        Technology
                    </label>
                    <select name="technology" multiple class="select-multi">
                        {% for tech in technologies %}
                        <option value="{{ tech }}">{{ tech }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="9" cy="7" r="3"/>
                            <circle cx="15" cy="7" r="3"/>
                            <path d="M3 18c0-3 3-5 6-5M15 13c3 0 6 2 6 5"/>
                        </svg>
                        Team
                    </label>
                    <select name="team" class="select-single">
                        <option value="">All Teams</option>
                        {% for t in teams %}
                        <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="8" r="4"/>
                            <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                        </svg>
                        Expert
                    </label>
                    <select name="expert" class="select-single">
                        <option value="">All Experts</option>
                        {% for e in experts %}
                        <option value="{{ e }}">{{ e }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                        </svg>
                        Export Type
                    </label>
                    <select name="export_type" class="select-single">
                        <option value="candidates">Candidates Data</option>
                        <option value="summary">Summary Report</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="export-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export Data
            </button>
            <button type="button" class="btn btn-ghost btn-lg" onclick="previewExport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Preview
            </button>
        </div>
    </form>

    <!-- Export Preview -->
    <div id="exportPreview" class="export-preview card" style="display: none;">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Export Preview
            </h3>
            <span id="previewCount" class="badge badge-info">0 records</span>
        </div>
        <div id="previewContent" class="preview-content">
            <div class="table-wrapper">
                <table class="data-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>Candidate Name</th>
                            <th>Email</th>
                            <th>Technology</th>
                            <th>Expert</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="preview-actions">
            <button type="button" class="btn btn-primary" onclick="downloadJSON()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Download JSON
            </button>
        </div>
    </div>

    <!-- Quick Export Options -->
    <div class="quick-exports">
        <h3 class="section-title">Quick Export Options</h3>
        <div class="quick-export-grid">
            <div class="quick-export-card card">
                <div class="quick-export-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                        <path d="M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                </div>
                <h4>All Candidates</h4>
                <p>Export all candidate records without filters</p>
                <form action="{{ url_for('analytics.export_download') }}" method="POST">
                    <input type="hidden" name="export_type" value="candidates">
                    <button type="submit" class="btn btn-ghost btn-sm">Export</button>
                </form>
            </div>

            <div class="quick-export-card card">
                <div class="quick-export-icon green">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <polyline points="22,4 12,14.01 9,11.01"/>
                    </svg>
                </div>
                <h4>Active Candidates</h4>
                <p>Export only candidates with active status</p>
                <form action="{{ url_for('analytics.export_download') }}" method="POST">
                    <input type="hidden" name="export_type" value="candidates">
                    <input type="hidden" name="status" value="active">
                    <button type="submit" class="btn btn-ghost btn-sm">Export</button>
                </form>
            </div>

            <div class="quick-export-card card">
                <div class="quick-export-icon orange">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </div>
                <h4>Scheduled Interviews</h4>
                <p>Export candidates with scheduled interviews</p>
                <form action="{{ url_for('analytics.export_download') }}" method="POST">
                    <input type="hidden" name="export_type" value="candidates">
                    <input type="hidden" name="status" value="scheduled">
                    <button type="submit" class="btn btn-ghost btn-sm">Export</button>
                </form>
            </div>

            <div class="quick-export-card card">
                <div class="quick-export-icon purple">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M18 20V10"/>
                        <path d="M12 20V4"/>
                        <path d="M6 20v-6"/>
                    </svg>
                </div>
                <h4>Summary Report</h4>
                <p>Export aggregated statistics and metrics</p>
                <form action="{{ url_for('analytics.export_download') }}" method="POST">
                    <input type="hidden" name="export_type" value="summary">
                    <button type="submit" class="btn btn-ghost btn-sm">Export</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let exportData = null;

async function previewExport() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);

    try {
        const response = await fetch('{{ url_for("analytics.export_download") }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            exportData = result.data;
            document.getElementById('previewCount').textContent = result.count + ' records';

            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';

            result.data.slice(0, 20).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Candidate Name'] || '-'}</td>
                    <td>${row['Email ID'] || '-'}</td>
                    <td><span class="badge badge-tech">${row['Technology'] || '-'}</span></td>
                    <td>${row['Expert'] || '-'}</td>
                    <td><span class="status-pill status-${(row['Status'] || 'unknown').toLowerCase()}">${row['Status'] || '-'}</span></td>
                `;
                tbody.appendChild(tr);
            });

            if (result.count > 20) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="text-center muted">... and ${result.count - 20} more records</td>`;
                tbody.appendChild(tr);
            }

            document.getElementById('exportPreview').style.display = 'block';
            document.getElementById('exportPreview').scrollIntoView({ behavior: 'smooth' });
        }
    } catch (error) {
        console.error('Preview failed:', error);
        alert('Failed to preview export. Please try again.');
    }
}

function downloadJSON() {
    if (!exportData) return;

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'candidates_export_' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Prevent form submission for preview
document.getElementById('exportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    previewExport();
});
</script>
{% endblock %}
