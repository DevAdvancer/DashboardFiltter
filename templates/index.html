{% extends "base.html" %}

{% block page_title %}Dashboard Overview - InterviewOS{% endblock %}
{% block title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="overview-dashboard">
    <!-- Hero Stats Grid -->
    <div class="hero-stats-grid">
        <div class="hero-stat-card">
            <div class="hero-stat-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                </svg>
            </div>
            <div class="hero-stat-content">
                <span class="hero-stat-value">{{ total_candidates }}</span>
                <span class="hero-stat-label">Total Candidates</span>
                <span class="hero-stat-sublabel">In the system</span>
            </div>
        </div>

        <div class="hero-stat-card">
            <div class="hero-stat-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2"/>
                    <path d="M16 3v4M8 3v4M2 11h20"/>
                </svg>
            </div>
            <div class="hero-stat-content">
                <span class="hero-stat-value">{{ total_interviews }}</span>
                <span class="hero-stat-label">Total Interviews</span>
                <span class="hero-stat-sublabel">All-time conducted</span>
            </div>
        </div>

        <div class="hero-stat-card">
            <div class="hero-stat-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
            </div>
            <div class="hero-stat-content">
                <span class="hero-stat-value">{{ completed_interviews }}</span>
                <span class="hero-stat-label">Completed</span>
                <span class="hero-stat-sublabel">{{ ((completed_interviews / total_interviews * 100) if total_interviews > 0 else 0) | round(1) }}% success rate</span>
            </div>
        </div>

        <div class="hero-stat-card">
            <div class="hero-stat-icon orange">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                </svg>
            </div>
            <div class="hero-stat-content">
                <span class="hero-stat-value">{{ active_count }}</span>
                <span class="hero-stat-label">Active Pipeline</span>
                <span class="hero-stat-sublabel">Candidates in progress</span>
            </div>
        </div>
    </div>

    <!-- Quick Analytics Links -->
    <div class="quick-links-section card">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                </svg>
                Quick Access to Analytics
            </h3>
        </div>
        <div class="quick-links-grid">
            <a href="{{ url_for('analytics.expert_analytics') }}" class="quick-link-card">
                <div class="quick-link-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="4"/>
                        <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                    </svg>
                </div>
                <div class="quick-link-content">
                    <h4>Expert Analytics</h4>
                    <p>Performance & funnel insights</p>
                </div>
            </a>

            <a href="{{ url_for('analytics.team_analytics') }}" class="quick-link-card">
                <div class="quick-link-icon purple">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="7" r="3"/>
                        <circle cx="15" cy="7" r="3"/>
                        <path d="M3 18c0-3 3-5 6-5M15 13c3 0 6 2 6 5"/>
                    </svg>
                </div>
                <div class="quick-link-content">
                    <h4>Team Analytics</h4>
                    <p>Team performance metrics</p>
                </div>
            </a>

            <a href="{{ url_for('analytics.funnel_analytics') }}" class="quick-link-card">
                <div class="quick-link-icon teal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 4h18l-6 8v6l-6 2V12L3 4z"/>
                    </svg>
                </div>
                <div class="quick-link-content">
                    <h4>Funnel Analytics</h4>
                    <p>Conversion & drop-off rates</p>
                </div>
            </a>

            <a href="{{ url_for('analytics.interview_records') }}" class="quick-link-card">
                <div class="quick-link-icon orange">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                    </svg>
                </div>
                <div class="quick-link-content">
                    <h4>Interview Records</h4>
                    <p>Detailed interview logs</p>
                </div>
            </a>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="charts-row-overview">
        <!-- Status Distribution -->
        <div class="chart-card card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                    </svg>
                    Candidate Status Distribution
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Interview Status -->
        <div class="chart-card card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                    Interview Status Breakdown
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="interviewStatusChart"></canvas>
            </div>
        </div>

        <!-- Technology Distribution -->
        <div class="chart-card card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    Top Technologies
                </h3>
            </div>
            <div class="chart-container">
                <canvas id="techChart"></canvas>
            </div>
        </div>
</div>

    <!-- Funnel Overview Section -->
    <div class="funnel-overview-section card">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 4h18l-6 8v6l-6 2V12L3 4z"/>
                </svg>
                Interview Funnel Overview
            </h3>
            <a href="{{ url_for('analytics.funnel_analytics') }}" class="btn btn-ghost btn-sm">View Details</a>
        </div>
        <div class="funnel-visual-dashboard">
            <div class="funnel-stage-dash">
                <div class="funnel-bar-dash screening" style="width: 100%;">
                    <span class="funnel-label">Screening</span>
                    <span class="funnel-count">{{ funnel_data.stages.Screening }}</span>
                </div>
                <span class="funnel-percent-dash">100%</span>
            </div>
            {% if funnel_data.stages.Screening > 0 %}
            <div class="funnel-arrow-dash">
                <span class="conversion-badge">{{ funnel_data.conversions.screening_to_1st }}%</span>
            </div>
            {% endif %}

            <div class="funnel-stage-dash">
                <div class="funnel-bar-dash first" style="width: {{ (funnel_data.stages['1st'] / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 }}%;">
                    <span class="funnel-label">1st Round</span>
                    <span class="funnel-count">{{ funnel_data.stages['1st'] }}</span>
                </div>
                <span class="funnel-percent-dash">{{ (funnel_data.stages['1st'] / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 | round(1) }}%</span>
            </div>
            {% if funnel_data.stages['1st'] > 0 %}
            <div class="funnel-arrow-dash">
                <span class="conversion-badge">{{ funnel_data.conversions['1st_to_2nd'] }}%</span>
            </div>
            {% endif %}

            <div class="funnel-stage-dash">
                <div class="funnel-bar-dash second" style="width: {{ (funnel_data.stages['2nd'] / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 }}%;">
                    <span class="funnel-label">2nd Round</span>
                    <span class="funnel-count">{{ funnel_data.stages['2nd'] }}</span>
                </div>
                <span class="funnel-percent-dash">{{ (funnel_data.stages['2nd'] / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 | round(1) }}%</span>
            </div>
            {% if funnel_data.stages['2nd'] > 0 %}
            <div class="funnel-arrow-dash">
                <span class="conversion-badge">{{ funnel_data.conversions['2nd_to_3rd'] }}%</span>
            </div>
            {% endif %}

            <div class="funnel-stage-dash">
                <div class="funnel-bar-dash third" style="width: {{ (funnel_data.stages['3rd/Technical'] / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 }}%;">
                    <span class="funnel-label">3rd/Technical</span>
                    <span class="funnel-count">{{ funnel_data.stages['3rd/Technical'] }}</span>
                </div>
                <span class="funnel-percent-dash">{{ (funnel_data.stages['3rd/Technical'] / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 | round(1) }}%</span>
            </div>
            {% if funnel_data.stages['3rd/Technical'] > 0 %}
            <div class="funnel-arrow-dash">
                <span class="conversion-badge">{{ funnel_data.conversions['3rd_to_final'] }}%</span>
                        </div>
                        {% endif %}

            <div class="funnel-stage-dash">
                <div class="funnel-bar-dash final" style="width: {{ (funnel_data.stages.Final / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 }}%;">
                    <span class="funnel-label">Final</span>
                    <span class="funnel-count">{{ funnel_data.stages.Final }}</span>
                </div>
                <span class="funnel-percent-dash">{{ (funnel_data.stages.Final / funnel_data.stages.Screening * 100) if funnel_data.stages.Screening > 0 else 0 | round(1) }}%</span>
            </div>
        </div>
    </div>

    <!-- Leaderboards Row -->
    <div class="leaderboards-row">
        <!-- Top Experts -->
        <div class="leaderboard-card card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L9 9l-7 1 5.5 5L6 22l6-3.5L18 22l-1.5-7 5.5-5-7-1z"/>
                    </svg>
                    Top Experts
                </h3>
                <a href="{{ url_for('analytics.expert_analytics') }}" class="btn btn-ghost btn-sm">View All</a>
            </div>
            <div class="leaderboard-list">
                {% for expert in top_experts[:5] %}
                <div class="leaderboard-item">
                    <div class="leaderboard-rank">{{ loop.index }}</div>
                    <div class="leaderboard-avatar">{{ expert.name[0]|upper }}</div>
                    <div class="leaderboard-info">
                        <span class="leaderboard-name">{{ expert.name }}</span>
                        <span class="leaderboard-meta">{{ expert.count }} interviews</span>
                    </div>
                    <div class="leaderboard-badge">{{ expert.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Top Teams -->
        <div class="leaderboard-card card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 2L9 9l-7 1 5.5 5L6 22l6-3.5L18 22l-1.5-7 5.5-5-7-1z"/>
                    </svg>
                    Top Teams
                </h3>
                <a href="{{ url_for('analytics.team_analytics') }}" class="btn btn-ghost btn-sm">View All</a>
            </div>
            <div class="leaderboard-list">
                {% for team in top_teams[:5] %}
                <div class="leaderboard-item">
                    <div class="leaderboard-rank">{{ loop.index }}</div>
                    <div class="leaderboard-team-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="7" r="3"/>
                            <circle cx="15" cy="7" r="3"/>
                            <path d="M3 18c0-3 3-5 6-5M15 13c3 0 6 2 6 5"/>
                        </svg>
                    </div>
                    <div class="leaderboard-info">
                        <span class="leaderboard-name">{{ team.name }}</span>
                        <span class="leaderboard-meta">{{ team.count }} interviews</span>
                    </div>
                    <div class="leaderboard-badge">{{ team.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="chart-card card trend-card">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/>
                    <polyline points="17,6 23,6 23,12"/>
                </svg>
                Activity Trend (Last 6 Months)
            </h3>
        </div>
        <div class="chart-container tall">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity-card card">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                </svg>
                Recent Candidate Activity
            </h3>
        </div>
        <div class="activity-list">
            {% for candidate in recent_candidates %}
            <div class="activity-item">
                <div class="activity-avatar">{{ candidate.get('Candidate Name', 'U')[0]|upper }}</div>
                <div class="activity-info">
                    <span class="activity-name">{{ candidate.get('Candidate Name', 'Unknown') }}</span>
                    <span class="activity-meta">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        </svg>
                        {{ candidate.get('Technology', 'N/A') }}
                    </span>
                </div>
                <span class="status-pill status-{{ candidate.get('workflowStatus', 'unknown')|lower|replace(' ', '_') }}">
                    {{ candidate.get('workflowStatus', 'Unknown') }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chart.js Dark Theme Defaults
Chart.defaults.color = '#94a3b8';
Chart.defaults.borderColor = '#2a2a3a';
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.padding = 16;
Chart.defaults.plugins.tooltip.backgroundColor = '#1a1a24';
Chart.defaults.plugins.tooltip.titleColor = '#f1f5f9';
Chart.defaults.plugins.tooltip.bodyColor = '#94a3b8';
Chart.defaults.plugins.tooltip.borderColor = '#2a2a3a';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.cornerRadius = 10;
Chart.defaults.plugins.tooltip.padding = 12;

// 1. Candidate Status Distribution
const statusData = {{ status_breakdown|tojson }};
const statusLabels = Object.keys(statusData);
const statusValues = Object.values(statusData);
const statusTotal = statusValues.reduce((a, b) => a + b, 0);

new Chart(document.getElementById('statusChart').getContext('2d'), {
    type: 'doughnut',
    data: {
        labels: statusLabels,
        datasets: [{
            data: statusValues,
            backgroundColor: [
                'rgba(16, 185, 129, 0.8)',
                'rgba(59, 130, 246, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(168, 85, 247, 0.8)',
                'rgba(100, 116, 139, 0.8)'
            ],
            borderColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#a855f7', '#64748b'],
            borderWidth: 2,
            hoverBorderWidth: 3,
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: (ctx) => {
                        const pct = ((ctx.raw / statusTotal) * 100).toFixed(1);
                        return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                    }
                }
            }
        }
    }
});

// 2. Interview Status Breakdown
new Chart(document.getElementById('interviewStatusChart').getContext('2d'), {
    type: 'doughnut',
    data: {
        labels: ['Completed', 'Cancelled', 'Rescheduled', 'Other'],
        datasets: [{
            data: [
                {{ completed_interviews }},
                {{ cancelled_interviews }},
                {{ rescheduled_interviews }},
                {{ total_interviews - completed_interviews - cancelled_interviews - rescheduled_interviews }}
            ],
            backgroundColor: [
                'rgba(16, 185, 129, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(100, 116, 139, 0.8)'
            ],
            borderColor: ['#10b981', '#ef4444', '#f59e0b', '#64748b'],
            borderWidth: 2,
            hoverBorderWidth: 3,
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
            legend: { position: 'bottom' },
            tooltip: {
                callbacks: {
                    label: (ctx) => {
                        const total = {{ total_interviews }};
                        const pct = ((ctx.raw / total) * 100).toFixed(1);
                        return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                    }
                }
            }
        }
    }
});

// 3. Technology Distribution
const techData = {{ technology_distribution|tojson }};
new Chart(document.getElementById('techChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: techData.map(t => t.name),
        datasets: [{
            label: 'Candidates',
            data: techData.map(t => t.count),
            backgroundColor: 'rgba(168, 85, 247, 0.8)',
            borderColor: '#a855f7',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(168, 85, 247, 1)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: (ctx) => `Count: ${ctx.raw}`
                }
            }
        },
        scales: {
            x: {
                grid: { display: false },
                ticks: { font: { size: 11 } }
            },
            y: {
                grid: { color: 'rgba(42, 42, 58, 0.5)' },
                ticks: { font: { size: 11 } }
            }
        }
    }
});

// 4. Monthly Trend
const monthlyData = {{ monthly_data|tojson }};
const trendCtx = document.getElementById('trendChart').getContext('2d');

const gradient1 = trendCtx.createLinearGradient(0, 0, 0, 300);
gradient1.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
gradient1.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

const gradient2 = trendCtx.createLinearGradient(0, 0, 0, 300);
gradient2.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
gradient2.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: monthlyData.map(m => m.month),
        datasets: [
            {
                label: 'Candidates',
                data: monthlyData.map(m => m.candidates),
                borderColor: '#3b82f6',
                backgroundColor: gradient1,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 10,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#16161e',
                pointBorderWidth: 2
            },
            {
                label: 'Interviews',
                data: monthlyData.map(m => m.interviews),
                borderColor: '#10b981',
                backgroundColor: gradient2,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 10,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#16161e',
                pointBorderWidth: 2
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: { position: 'top' },
            tooltip: {
                callbacks: {
                    label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}`
                }
            }
        },
        scales: {
            x: {
                grid: { color: 'rgba(42, 42, 58, 0.3)' },
                ticks: { font: { size: 11 } }
            },
            y: {
                grid: { color: 'rgba(42, 42, 58, 0.3)' },
                ticks: { font: { size: 11 } }
            }
        }
    }
});
</script>
{% endblock %}
