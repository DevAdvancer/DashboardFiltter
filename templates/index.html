{% extends "base.html" %}

{% block page_title %}Dashboard Overview - InterviewOS{% endblock %}
{% block title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Filters Panel -->
    <div class="filters-panel card">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/>
                </svg>
                Filters
            </h3>
            <a href="{{ url_for('dashboard.index') }}" class="btn btn-ghost btn-sm">Reset</a>
        </div>

        <form id="filter-form" action="{{ url_for('dashboard.index') }}" method="GET" class="filter-form">
            <div class="filter-grid">
                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Start Date
                    </label>
                    <input type="date" name="start_date" value="{{ start_date or '' }}" class="date-input">
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        End Date
                    </label>
                    <input type="date" name="end_date" value="{{ end_date or '' }}" class="date-input">
                </div>
                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M8 12l2 2 4-4"/>
                        </svg>
                        Status
                    </label>
                    <select name="status" multiple class="select-multi">
                        {% for s in workflow_statuses %}
                        <option value="{{ s }}" {% if s in selected_status %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="9" cy="7" r="3"/>
                            <circle cx="15" cy="7" r="3"/>
                            <path d="M3 18c0-3 3-5 6-5M15 13c3 0 6 2 6 5"/>
                        </svg>
                        Teams
                    </label>
                    <select name="team" multiple class="select-multi">
                        {% for t in all_teams %}
                        <option value="{{ t }}" {% if t in selected_teams %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="8" r="4"/>
                            <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                        </svg>
                        Expert
                    </label>
                    <select name="expert" multiple class="select-multi">
                        {% for e in experts %}
                        <option value="{{ e }}" {% if e in selected_experts %}selected{% endif %}>{{ e }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                        Technology
                    </label>
                    <select name="technology" multiple class="select-multi">
                        {% for tech in technologies %}
                        <option value="{{ tech }}" {% if tech in selected_tech %}selected{% endif %}>{{ tech }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 00-3-3.87"/>
                            <path d="M16 3.13a4 4 0 010 7.75"/>
                        </svg>
                        Recruiter
                    </label>
                    <select name="recruiter" multiple class="select-multi">
                        {% for r in recruiters %}
                        <option value="{{ r }}" {% if r in selected_recruiter %}selected{% endif %}>{{ r }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        Branch
                    </label>
                    <select name="branch" multiple class="select-multi">
                        {% for b in branches %}
                        <option value="{{ b }}" {% if b in selected_branches %}selected{% endif %}>{{ b }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="7" width="20" height="14" rx="2"/>
                            <path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/>
                        </svg>
                        Brand
                    </label>
                    <select name="brand" multiple class="select-multi">
                        {% for b in brands %}
                        <option value="{{ b }}" {% if b in selected_brands %}selected{% endif %}>{{ b }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-field">
                    <label>
                        <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Resume Status
                    </label>
                    <select name="resume_status" multiple class="select-multi">
                        {% for r in resume_statuses %}
                        <option value="{{ r }}" {% if r in selected_resume_statuses %}selected{% endif %}>{{ r }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-block">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/>
                </svg>
                Apply Filters
            </button>
        </form>
    </div>

    <!-- Stats Cards -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Total Candidates</span>
                <span class="stat-value">{{ total_count }}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Active</span>
                <span class="stat-value">{{ active_count }}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon orange">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Scheduled</span>
                <span class="stat-value">{{ scheduled_count }}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon red">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">Rejected</span>
                <span class="stat-value">{{ rejected_count }}</span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
        <div class="chart-card card">
            <div class="card-header">
                <h3 class="card-title">Status Distribution</h3>
            </div>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <div class="chart-card card">
            <div class="card-header">
                <h3 class="card-title">Conversion Funnel</h3>
            </div>
            <div class="chart-container">
                <canvas id="funnelChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Candidates Table -->
    <div class="table-section card">
        <div class="card-header">
            <h3 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                </svg>
                Candidates
            </h3>
            <span class="badge badge-info">{{ total_count }} total</span>
</div>

        <div class="table-wrapper">
            <table class="data-table">
            <thead>
                <tr>
                        <th>Candidate</th>
                    <th>Technology</th>
                    <th>Expert / Recruiter</th>
                        <th>Branch / Brand</th>
                    <th>Status</th>
                        <th>Updated</th>
                </tr>
            </thead>
            <tbody>
                {% for c in candidates %}
                <tr>
                    <td>
                            <div class="candidate-cell">
                                <span class="candidate-name">{{ c.get('Candidate Name', 'N/A') }}</span>
                                <span class="candidate-email">{{ c.get('Email ID', '') }}</span>
                                {% if c.get('Contact No') %}
                                <span class="candidate-phone">{{ c.get('Contact No') }}</span>
                                {% endif %}
                            </div>
                    </td>
                    <td>
                            <span class="badge badge-tech">{{ c.get('Technology', '-') }}</span>
                    </td>
                    <td>
                            <div class="dual-cell">
                                <span class="primary-text">{{ c.get('Expert', '-') }}</span>
                                <span class="secondary-text">{{ c.get('Recruiter', '-') }}</span>
                            </div>
                    </td>
                    <td>
                            <div class="dual-cell">
                                <span class="primary-text">{{ c.get('Branch', '-') }}</span>
                                <span class="secondary-text">{{ c.get('Brand', '-') }}</span>
                            </div>
                    </td>
                    <td>
                            <span class="status-pill status-{{ c.get('workflowStatus', 'unknown')|lower }}">
                            {{ c.get('workflowStatus', 'Unknown') }}
                        </span>
                    </td>
                    <td>
                            <span class="date-cell">{{ c.get('updated_at', 'N/A') }}</span>
                    </td>
                </tr>
                {% else %}
                <tr>
                        <td colspan="6" class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            <p>No candidates found matching your filters</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

        <!-- Pagination -->
        <div class="pagination">
            <span class="pagination-info">Page {{ page }} of {{ ((total_count - 1) // per_page) + 1 }}</span>
            <div class="pagination-actions">
            {% if page > 1 %}
                <a href="{{ url_for('dashboard.index', page=page-1, **request.args) }}" class="btn btn-ghost btn-sm">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="15,18 9,12 15,6"/>
                    </svg>
                    Previous
                </a>
                {% endif %}
                {% if page * per_page < total_count %}
                <a href="{{ url_for('dashboard.index', page=page+1, **request.args) }}" class="btn btn-primary btn-sm">
                    Next
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="9,18 15,12 9,6"/>
                    </svg>
                </a>
            {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_data %}
<script>
window.teamsMap = {{ teams_map|tojson }};
</script>
{% endblock %}

{% block scripts %}
<script>
// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Active', 'Scheduled', 'Rejected', 'Other'],
        datasets: [{
            data: [{{ active_count }}, {{ scheduled_count }}, {{ rejected_count }}, {{ total_count - active_count - scheduled_count - rejected_count }}],
            backgroundColor: ['#22c55e', '#f97316', '#ef4444', '#94a3b8'],
            borderWidth: 0,
            spacing: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    font: { family: 'Plus Jakarta Sans', size: 12 }
                }
            }
        }
    }
});

// Funnel Chart
const funnelCtx = document.getElementById('funnelChart').getContext('2d');
new Chart(funnelCtx, {
    type: 'bar',
    data: {
        labels: ['Total', 'Active', 'Scheduled', 'Rejected'],
        datasets: [{
            data: [{{ total_count }}, {{ active_count }}, {{ scheduled_count }}, {{ rejected_count }}],
            backgroundColor: ['#3b82f6', '#22c55e', '#f97316', '#ef4444'],
            borderRadius: 8,
            borderSkipped: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: {
                grid: { display: false },
                ticks: { font: { family: 'Plus Jakarta Sans', size: 11 } }
            },
            y: {
                grid: { display: false },
                ticks: { font: { family: 'Plus Jakarta Sans', size: 12, weight: 500 } }
            }
        }
    }
});
</script>
{% endblock %}
