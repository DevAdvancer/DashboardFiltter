{% extends "base.html" %}

{% block page_title %}KPI Sidebar - Expert First Assignment Analytics{% endblock %}
{% block title %}KPI Sidebar{% endblock %}

{% block content %}
<div class="analytics-page">
  <!-- Quick Select Filters -->
  <div class="quick-filters card">
    <div class="quick-filters-label">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
        <circle cx="12" cy="12" r="10" />
        <polyline points="12,6 12,12 16,14" />
      </svg>
      <span>Quick Select:</span>
    </div>
    <div class="quick-filters-buttons">
      <button type="button" class="btn btn-ghost btn-sm quick-select" data-days="7">Last 7 Days</button>
      <button type="button" class="btn btn-ghost btn-sm quick-select" data-days="30">Last 30 Days</button>
      <button type="button" class="btn btn-ghost btn-sm quick-select" data-days="90">Last 90 Days</button>
      <button type="button" class="btn btn-ghost btn-sm quick-select" data-range="this-month">This Month</button>
      <button type="button" class="btn btn-ghost btn-sm quick-select" data-range="last-month">Last Month</button>
      <button type="button" class="btn btn-ghost btn-sm quick-select" data-range="all-time">All Time</button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-card card">
    <form method="GET" action="{{ url_for('kpi.kpi_sidebar') }}" class="filters-form" id="filterForm">
      <div class="filters-row">
        <div class="filter-item">
          <label>
            <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="4" width="18" height="18" rx="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            Start Date
          </label>
          <input type="date" name="start_date" value="{{ start_date or '' }}" class="date-input">
        </div>
        <div class="filter-item">
          <label>
            <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="4" width="18" height="18" rx="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            End Date
          </label>
          <input type="date" name="end_date" value="{{ end_date or '' }}" class="date-input">
        </div>
        <div class="filter-item">
          <label>
            <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
              <circle cx="9" cy="7" r="4" />
              <path d="M23 21v-2a4 4 0 00-3-3.87" />
              <path d="M16 3.13a4 4 0 010 7.75" />
            </svg>
            Team
          </label>
          <select name="team" class="select-single">
            <option value="">All Teams</option>
            {% for team in teams %}
            <option value="{{ team }}" {% if selected_team==team %}selected{% endif %}>{{ team }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-item">
          <label>
            <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="8" r="4" />
              <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
            </svg>
            Expert
          </label>
          <select name="expert" class="select-single">
            <option value="">All Experts</option>
            {% for expert in experts %}
            <option value="{{ expert }}" {% if selected_expert==expert %}selected{% endif %}>{{ expert.split('@')[0] }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-item">
          <label>
            <svg class="label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" />
              <line x1="9" y1="9" x2="15" y2="9" />
              <line x1="9" y1="13" x2="15" y2="13" />
              <line x1="9" y1="17" x2="12" y2="17" />
            </svg>
            Interview Subject
          </label>
          <select name="round" class="select-single">
            <option value="">All Titles</option>
            {% for round in round_titles %}
            <option value="{{ round }}" {% if selected_round==round %}selected{% endif %}>{{ round }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-item">
          <label class="label-exclude">Exclude Titles</label>
          <div class="custom-multi-select" id="excludeDropdown">
            <div class="multi-select-trigger" onclick="toggleMultiSelect()">
              <span id="excludeTriggerText">Select Titles...</span>
              <svg class="trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="multi-select-options">
              {% for round in round_titles %}
              <label class="multi-select-option">
                <input type="checkbox" name="exclude_rounds" value="{{ round }}" {% if round in exclude_rounds
                  %}checked{% endif %} onchange="updateMultiSelectText()">
                <span class="option-text">{{ round }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46" />
            </svg>
            Apply
          </button>
          <a href="{{ url_for('kpi.kpi_sidebar') }}" class="btn btn-ghost">Reset</a>
        </div>
      </div>
    </form>
  </div>

  <!-- Summary Cards -->
  {% if kpi_data and kpi_data.summary %}
  <div class="stats-row">
    <div class="stat-card stat-card-primary">
      <div class="stat-icon-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M23 21v-2a4 4 0 00-3-3.87" />
          <path d="M16 3.13a4 4 0 010 7.75" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ kpi_data.summary.total_experts }}</span>
        <span class="stat-label">Experts</span>
      </div>
    </div>
    <div class="stat-card stat-card-green">
      <div class="stat-icon-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <circle cx="12" cy="8" r="4" />
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ kpi_data.summary.total_candidates }}</span>
        <span class="stat-label">Candidates</span>
      </div>
    </div>
    <div class="stat-card stat-card-orange">
      <div class="stat-icon-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <rect x="3" y="4" width="18" height="18" rx="2" />
          <line x1="9" y1="9" x2="15" y2="9" />
          <line x1="9" y1="13" x2="15" y2="13" />
          <line x1="9" y1="17" x2="12" y2="17" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ kpi_data.summary.total_interviews }}</span>
        <span class="stat-label">Interviews</span>
      </div>
    </div>
    <div class="stat-card stat-card-teal">
      <div class="stat-icon-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
          <polyline points="20,6 9,17 4,12" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ kpi_data.summary.avg_match_rate }}%</span>
        <span class="stat-label">Avg Match Rate</span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Expert KPI Table -->
  <div class="content-card card">
    <div class="card-header">
      <h2 class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
          <path d="M12 2L2 7l10 5 10-5-10-5z" />
          <path d="M2 17l10 5 10-5" />
          <path d="M2 12l10 5 10-5" />
        </svg>
        Expert First Assignment KPIs
      </h2>
      <span class="badge badge-subtle">First-assigned attribution</span>
    </div>

    {% if kpi_data and kpi_data.experts %}
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Team</th>
            <th>Expert</th>
            <th>Candidates</th>
            <th>Interviews</th>
            <th>Matched</th>
            <th>Match Rate</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for stat in kpi_data.experts %}
          <tr>
            <td><span class="rank-badge">{{ loop.index }}</span></td>
            <td><span class="badge badge-subtle">{{ stat.team }}</span></td>
            <td>
              <div class="expert-cell">
                <div class="expert-avatar small">{{ stat.expert[0]|upper }}</div>
                <span>{{ stat.expert.split('@')[0] }}</span>
              </div>
            </td>
            <td class="text-bold">{{ stat.total_candidates }}</td>
            <td class="text-bold">{{ stat.total_interviews }}</td>
            <td>
              {{ stat.matched_candidates }}
              <span class="text-xs text-secondary" title="{{ stat.matched_interviews }} matched interviews">({{
                stat.matched_interviews }})</span>
            </td>
            <td>
              <div class="match-rate-cell">
                <div class="match-rate-bar">
                  <div
                    class="match-rate-fill {% if stat.match_rate >= 80 %}high{% elif stat.match_rate >= 50 %}medium{% else %}low{% endif %}"
                    style="width: {{ stat.match_rate }}%"></div>
                </div>
                <span class="match-rate-value">{{ stat.match_rate }}%</span>
              </div>
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-view" data-expert="{{ stat.expert }}"
                onclick="viewMatchedCandidates('{{ stat.expert }}')" title="View matched candidates">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                View
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
        <circle cx="12" cy="12" r="10" />
        <path d="M8 15h8" />
        <circle cx="9" cy="9" r="1" />
        <circle cx="15" cy="9" r="1" />
      </svg>
      <h3>No Data Available</h3>
      <p>No KPI data found for the selected filters. Try adjusting your date range or filters.</p>
    </div>
    {% endif %}
  </div>

  <!-- Info Card -->
  <div class="info-card card">
    <div class="card-header">
      <h3 class="card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="16" x2="12" y2="12" />
          <line x1="12" y1="8" x2="12.01" y2="8" />
        </svg>
        About First Assignment Attribution
      </h3>
    </div>
    <div class="info-content">
      <p><strong>First-Assigned Expert:</strong> Candidates are attributed to the first expert who was assigned to them,
        parsed from the <code>replies</code> field in interview records.</p>
      <p><strong>Match Rate:</strong> Percentage of candidates where the first-assigned expert matches the
        <code>Expert</code> field in candidate details.
      </p>
    </div>
  </div>

  <!-- Modal for Matched Candidates -->
  <div id="matchedModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3 id="modalTitle">Matched Candidates</h3>
        <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-tabs">
        <button type="button" class="modal-tab active" data-tab="matched" onclick="switchTab('matched')">
          ✅ Matched (<span id="matchedCount">0</span>) - <span id="matchedTotalInterviews">0</span> interviews
        </button>
        <button type="button" class="modal-tab" data-tab="unmatched" onclick="switchTab('unmatched')">
          ❌ Unmatched (<span id="unmatchedCount">0</span>) - <span id="unmatchedTotalInterviews">0</span> interviews
        </button>
      </div>
      <div class="modal-body">
        <div id="modalLoading" class="modal-loading">
          <div class="spinner"></div>
          <span>Loading candidates...</span>
        </div>
        <div id="matchedTab" class="tab-content">
          <table class="modal-table">
            <thead>
              <tr>
                <th style="width:25%">Candidate</th>
                <th>Subjects</th>
                <th style="width:60px">Count</th>
              </tr>
            </thead>
            <tbody id="matchedList"></tbody>
          </table>
        </div>
        <div id="unmatchedTab" class="tab-content" style="display: none;">
          <table class="modal-table">
            <thead>
              <tr>
                <th style="width:20%">Candidate</th>
                <th>Subjects</th>
                <th style="width:50px">Count</th>
                <th style="width:20%">Actual Expert</th>
              </tr>
            </thead>
            <tbody id="unmatchedList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* KPI Sidebar specific styles */
    .match-rate-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .match-rate-bar {
      width: 80px;
      height: 6px;
      background: var(--bg-alt);
      border-radius: 3px;
      overflow: hidden;
    }

    .match-rate-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .match-rate-fill.high {
      background: var(--green);
    }

    .match-rate-fill.medium {
      background: var(--orange);
    }

    .match-rate-fill.low {
      background: var(--red);
    }

    .match-rate-value {
      font-weight: 600;
      font-size: 12px;
      min-width: 45px;
    }

    .info-card {
      margin-top: 24px;
      background: var(--surface);
    }

    .info-content {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .exclude-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .exclude-checkbox input {
      accent-color: var(--red);
    }

    .exclude-checkbox span {
      color: var(--red);
      font-weight: 500;
    }

    .label-exclude {
      color: var(--red);
    }

    .select-multi-exclude {
      min-width: 180px;
      padding: 6px;
      border: 1px solid var(--red);
      border-radius: var(--radius);
      background: var(--surface);
      font-size: 13px;
      color: var(--text);
    }

    .select-multi-exclude option:checked {
      background: var(--red-light);
      color: var(--red);
    }

    .info-content p {
      margin-bottom: 8px;
    }

    .info-content code {
      background: var(--bg-alt);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--primary);
    }

    .stat-card-primary .stat-icon-wrap {
      color: var(--primary);
      background: var(--primary-light);
    }

    .stat-card-green .stat-icon-wrap {
      color: var(--green);
      background: var(--green-light);
    }

    .stat-card-orange .stat-icon-wrap {
      color: var(--orange);
      background: var(--orange-light);
    }

    .stat-card-teal .stat-icon-wrap {
      color: var(--teal);
      background: var(--teal-light);
    }

    .stat-icon-wrap {
      width: 48px;
      height: 48px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--bg-alt);
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .modal-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .modal-tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
    }

    .modal-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .modal-body {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px;
      color: var(--text-secondary);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .modal-table {
      width: 100%;
      font-size: 13px;
    }

    .modal-table th,
    .modal-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .modal-table th {
      background: var(--bg-alt);
      font-weight: 600;
    }

    .subject-list {
      margin: 0;
      padding-left: 16px;
      list-style-type: disc;
    }

    .subject-list li {
      padding: 2px 0;
      font-size: 12px;
      line-height: 1.4;
    }

    .total-row {
      background: var(--bg-alt);
      border-top: 2px solid var(--primary);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-view {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--primary-light);
      color: var(--primary);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .btn-view:hover {
      background: var(--primary);
      color: white;
    }

    /* Custom Multi Select */
    .custom-multi-select {
      position: relative;
      width: 100%;
      min-width: 200px;
    }

    .multi-select-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      background-color: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      min-height: 38px;
      color: var(--text);
    }

    .multi-select-trigger:hover {
      border-color: var(--primary);
      background-color: var(--surface-hover);
    }

    .multi-select-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 100;
      background-color: #16161e;
      border: 1px solid var(--border-strong);
      border-radius: var(--radius);
      margin-top: 4px;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
    }

    .custom-multi-select.open .multi-select-options {
      display: block;
    }

    .multi-select-option {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      transition: background 0.1s;
      width: 100%;
      text-align: left;
      border: none;
      background: none;
      color: var(--text);
      border-bottom: 1px solid var(--border);
    }

    .multi-select-option:last-child {
      border-bottom: none;
    }

    .multi-select-option:hover {
      background-color: var(--surface-hover);
    }

    .multi-select-option input {
      margin-right: 0.5rem;
      accent-color: var(--primary);
      width: 16px;
      height: 16px;
    }

    .trigger-icon {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }
  </style>

  <script>
    // Experts grouped by team (passed from backend)
    const expertsByTeam = {{ experts_by_team | tojson | safe }};
    const allExperts = {{ experts | tojson | safe }};

    document.addEventListener('DOMContentLoaded', function () {
      const teamSelect = document.querySelector('select[name="team"]');
      const expertSelect = document.querySelector('select[name="expert"]');
      const selectedExpert = "{{ selected_expert or '' }}";

      // Filter experts based on team selection
      function updateExpertDropdown() {
        const selectedTeam = teamSelect.value;
        expertSelect.innerHTML = '<option value="">All Experts</option>';

        let expertsToShow = selectedTeam ? (expertsByTeam[selectedTeam] || []) : allExperts;

        expertsToShow.forEach(email => {
          const option = document.createElement('option');
          option.value = email;
          option.textContent = email.split('@')[0];
          if (email === selectedExpert) option.selected = true;
          expertSelect.appendChild(option);
        });
      }

      // Update on team change
      teamSelect.addEventListener('change', updateExpertDropdown);

      // Initial filter on page load
      updateExpertDropdown();

      // Quick select buttons
      document.querySelectorAll('.quick-select').forEach(btn => {
        btn.addEventListener('click', function () {
          const days = this.dataset.days;
          const range = this.dataset.range;
          const startInput = document.querySelector('input[name="start_date"]');
          const endInput = document.querySelector('input[name="end_date"]');

          const today = new Date();
          let start, end;

          if (days) {
            end = today;
            start = new Date(today);
            start.setDate(start.getDate() - parseInt(days));
          } else if (range === 'this-month') {
            start = new Date(today.getFullYear(), today.getMonth(), 1);
            end = today;
          } else if (range === 'last-month') {
            start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            end = new Date(today.getFullYear(), today.getMonth(), 0);
          } else if (range === 'this-year') {
            start = new Date(today.getFullYear(), 0, 1);
            end = today;
          } else if (range === 'all-time') {
            startInput.value = '';
            endInput.value = '';
            document.getElementById('filterForm').submit();
            return;
          }

          if (start && end) {
            startInput.value = start.toISOString().split('T')[0];
            endInput.value = end.toISOString().split('T')[0];
            document.getElementById('filterForm').submit();
          }
        });
      });
    });

    // Modal functions
    function viewMatchedCandidates(expertEmail) {
      const modal = document.getElementById('matchedModal');
      const loading = document.getElementById('modalLoading');
      const matchedList = document.getElementById('matchedList');
      const unmatchedList = document.getElementById('unmatchedList');
      const matchedTab = document.getElementById('matchedTab');
      const unmatchedTab = document.getElementById('unmatchedTab');

      // Set title
      document.getElementById('modalTitle').textContent = 'Candidates for ' + expertEmail.split('@')[0];

      // Show modal with loading
      modal.style.display = 'flex';
      loading.style.display = 'flex';
      matchedTab.style.display = 'none';
      unmatchedTab.style.display = 'none';

      // Get current filter params
      const params = new URLSearchParams(window.location.search);
      params.set('expert', expertEmail);

      fetch('/kpi/api/matched-candidates?' + params.toString())
        .then(res => res.json())
        .then(data => {
          loading.style.display = 'none';

          if (data.success) {
            // Update counts
            document.getElementById('matchedCount').textContent = data.total_matched;
            document.getElementById('unmatchedCount').textContent = data.total_unmatched;

            // Populate matched list with total
            const matchedTotal = data.matched.reduce((sum, c) => sum + c.subjects.length, 0);
            matchedList.innerHTML = data.matched.length ?
              data.matched.map(c => `<tr><td>${c.name}</td><td><ul class="subject-list">${c.subjects.map(s => `<li>${s}</li>`).join('') || '<li>-</li>'}</ul></td><td style="text-align:center;font-weight:600">${c.subjects.length}</td></tr>`).join('') +
              `<tr class="total-row"><td colspan="2" style="text-align:right;font-weight:700">Total Interviews:</td><td style="text-align:center;font-weight:700;color:var(--primary)">${matchedTotal}</td></tr>` :
              '<tr><td colspan="3" style="text-align:center;color:var(--text-secondary);">No matched candidates</td></tr>';
            document.getElementById('matchedTotalInterviews').textContent = matchedTotal;

            // Populate unmatched list with total
            const unmatchedTotal = data.unmatched.reduce((sum, c) => sum + c.subjects.length, 0);
            unmatchedList.innerHTML = data.unmatched.length ?
              data.unmatched.map(c => `<tr><td>${c.name}</td><td><ul class="subject-list">${c.subjects.map(s => `<li>${s}</li>`).join('') || '<li>-</li>'}</ul></td><td style="text-align:center;font-weight:600">${c.subjects.length}</td><td>${c.actual_expert || 'Not found'}</td></tr>`).join('') +
              `<tr class="total-row"><td colspan="2" style="text-align:right;font-weight:700">Total Interviews:</td><td style="text-align:center;font-weight:700;color:var(--primary)">${unmatchedTotal}</td><td></td></tr>` :
              '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);">No unmatched candidates</td></tr>';
            document.getElementById('unmatchedTotalInterviews').textContent = unmatchedTotal;

            // Show matched tab by default
            switchTab('matched');
          } else {
            matchedList.innerHTML = '<tr><td colspan="3">Error loading data</td></tr>';
            matchedTab.style.display = 'block';
          }
        })
        .catch(err => {
          loading.style.display = 'none';
          matchedList.innerHTML = '<tr><td colspan="3">Error: ' + err.message + '</td></tr>';
          matchedTab.style.display = 'block';
        });
    }

    function closeModal() {
      document.getElementById('matchedModal').style.display = 'none';
    }

    function switchTab(tabName) {
      const matchedTab = document.getElementById('matchedTab');
      const unmatchedTab = document.getElementById('unmatchedTab');
      const tabs = document.querySelectorAll('.modal-tab');

      tabs.forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      if (tabName === 'matched') {
        matchedTab.style.display = 'block';
        unmatchedTab.style.display = 'none';
      } else {
        matchedTab.style.display = 'none';
        unmatchedTab.style.display = 'block';
      }
    }

    // Close modal on overlay click
    document.getElementById('matchedModal')?.addEventListener('click', function (e) {
      if (e.target === this) closeModal();
    });
    function toggleMultiSelect() {
      const dropdown = document.getElementById('excludeDropdown');
      dropdown.classList.toggle('open');
    }

    function updateMultiSelectText() {
      const checkboxes = document.querySelectorAll('input[name="exclude_rounds"]:checked');
      const textSpan = document.getElementById('excludeTriggerText');

      if (checkboxes.length === 0) {
        textSpan.textContent = "Select Titles...";
        textSpan.style.color = "var(--text-muted)";
      } else if (checkboxes.length === 1) {
        textSpan.textContent = checkboxes[0].nextElementSibling.textContent;
        textSpan.style.color = "var(--text-primary)";
      } else {
        textSpan.textContent = `${checkboxes.length} Excluded`;
        textSpan.style.color = "var(--text-primary)";
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
      const dropdown = document.getElementById('excludeDropdown');
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
      }
    });

    // Init text on load
    document.addEventListener('DOMContentLoaded', updateMultiSelectText);
  </script>
  {% endblock %}